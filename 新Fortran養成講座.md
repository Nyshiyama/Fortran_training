# 新Fortran養成講座

[TOC]

## はじめに

2020年度から，より実態に根ざした形としてFortran養成講座が生まれ変わりました．ネット上でもFortran学習プラットフォームは他プログラミング言語に比べて圧倒的に少ないため，本講座がFortran学習の上での一助になればこれ幸い．

## そもFortranってなーに？

古代兵器である．ピチューン．以下略

## 学習の流れ

ここでは[Fortran養成講座（メインコンテンツ）](#Fortran養成講座（メインコンテンツ）)として，最終的に2次元の熱伝導方程式をFortranで記述，および記述されたサンプルコードが理解できるようになることを目標としてFortranを学習する．具体的な流れとしては，

1. プログラミングの前段階として，「コマンド」「Git」の勉強，およびプログラミング環境の構築
1. 2次元熱伝導方程式を段階的に記述，段階に合わせて最低限の知識を習得
1. 今回の熱伝導方程式では使わないが予備知識として持っておくべき事柄を学習
1. より高みを目指したい人向けのコンテンツもあり

## Fortran養成講座（メインコンテンツ）

### 前段階

1. Command lineの勉強を[Progate](https://prog-8.com/languages/commandline)で行う（登録は無料で良い，Google等のアカウントも利用可能）
1. Gitの勉強を[Progate](https://prog-8.com/languages/git)で行う
1. Gitを自分のPCに導入する
   1. 編集街
   1. 最後に見本のGitリポジトリをクローン
1. 研究室の計算機を使える環境を整える
   1. 編集街
1. コーディングするべき2次元熱伝導方程式をひとまず見る
   1. 編集街
   1. 数式等

### 2次元熱伝導方程式の記述フロー

1. 世界に「こんにちは」
   「Hello world」をターミナル上に出力せよ．

1. 暗黙の型宣言絶対殺すマン
   **必ず`implicit none`を入れること**．予期せぬエラーを招く．エラー例は後述．

1. 四則演算してみる
   陽解法における式〇〇（編集街）を倍精度で計算し，`rx`，`ry`，`u_new`をターミナル出力せよ．以下要件：

   - 倍精度は`double precision`で記述する
   - 倍精度で数値を入力する場合，末尾に`d0`をつける（ex. `a=0d0`）
   - 式〇〇（編集街）はひとまずの簡易形として〇〇（編集街）を計算する
   - 各初期値として`u=0d0`，`uxp=uxm=uyp=uym=1d0`
   - 格子幅はx方向`delta_x=0.2d0`，y方向`0.3d0`，時間間隔`delta_t=0.001d0`とする

1. デバッグと可読性の高いコードを書く練習
   サンプルリポジトリの中に`shisokubug_ex.f90`という，前問の解答例に意図的にバグを仕込んだファイルを置いているので，デバッグして`u_new`の出力結果を本来の値に直せ．以下要件：

   - ひとまずそのまま`gfortran shisokubug_ex.f90`でコンパイルし，実行してみて結果がおかしいことを確認する
   - インデントを整理する
   - `gfortran -Wall -pedantic -std=f95 -fbounds-check -O -Wuninitialized -ffpe-trap=invalid,zero,overflow -fbacktrace shisokubug_ex.f90`でコンパイルし，エラーメッセージを読み取ってデバッグする

1. 入力出力とファイル操作
   初期値として`uxp=uxm=uyp=uym=1d0`をコード上で与えていたが，ターミナル入力に変更せよ．また，`rx`，`ry`，`u_new`をターミナル出力していたがファイル出力に変更せよ．以下要件：

   - ファイル出力は`rx`，`ry`と`u_new`に分けて行う（前者の出力後すぐ`close`する）
   - ファイル出力は同一ファイルに行う
   - `append`を使って2度に分けられたファイル出力で上書き出力されないようにする

1. 変数定義に属性をつける
   固定値として「格子幅はx方向`delta_x=0.2d0`，y方向`0.3d0`，時間間隔`delta_t=0.001d0`と」しているので，これらに`parameter`属性をつけよ．

1. 配列の定義
   サンプルコードで`u`と`u_new`をスカラーとしているが，配列にせよ．以下要件：

   - 配列宣言には`dimension`属性を使う
   - 格子点数を`parameter`属性でx方向`nx=30`，y方向`ny=20`と定義
   - 配列サイズは`(nx,ny)`（これは`(1:nx,1:ny)`と同じ）
   - 配列サイズの指定に数値を直接入れてはいけない（`(30,20)`は禁止）

   - `u_new=rx*...u`としていたが，ひとまず`u_new(2,2)=rx*...u(2,2)`として格子点`(2,2)`における値のみを計算する（`u_new(i,j)=...`で`i=j=2`としてもよい）
   - `uxp=uxm=uyp=uym=1d0`としていたが，上記`(2,2)`に合わせて`u`で表現する（ためにひとまずの計算は`(1,1)`ではなく`(2,2)`にする）
   - 初期値として`u=0d0`としていたが，配列であることを明示するためにコロン`:`を使う

1. do文
   点`(2,2)`のみ計算していたが，`do`を使って配列サイズ`(nx,ny)`全体を計算せよ．以下要件：

   - x，yはどちらも周期境界，つまり「`nx`の次」は本来`nx+1`だが，配列サイズが`nx`までなので先頭の`1`とすることで，周期=グルグル回り続けるようにする
   - 配列は`(i,j)`として`i`，`j`の2重`do`ループを実装する

1. 配列をファイル出力する際のパターンを示す例題
    別ファイルとして`opendo_ex.f90`を用意したので実行して結果を確認せよ．以下要件：

    - 単なる確認だが，それぞれのコーディングで配列の中身が出力される順番を理解してほしい（Fortranは列優先のためコロン型と1行do文型が同じ出力順番になる）

1. 論理型でif文
    障害物として上下（x，y方向）両端に壁を置き，障害物以外の格子点のみ計算せよ．以下要件：

    - 障害物情報を格納する変数として`u`と同じ配列サイズの`logical`型変数`obs`を定義
    - `obs`の真が障害物（固相），偽が非障害物（流体相）とする
    - `u(nx,ny)`の初期値を，障害物上では`0d0`，非障害物上では`1d0`とする
    - `i`，`j`の二重`do`ループ内に`if`文で`obs`の条件をつける

1. 行の継続 (&) とセミコロン (;) の使い方
    各自で[Fortran 入門: プログラムの書き方についての規則](https://www.nag-j.co.jp/fortran/FI_3.html)のうち，`&`，`;`の使い方を確認せよ．以下要件：

    - 使う場合は可読性とよく相談する
    - Fortranの旧規格（ファイルの拡張子が`f`もしくは`F`，固定形式）では`&`の位置がファイル左端から6文字目に限定されていることは知識として知っておく

1. 文字列の操作
    新しいファイルで，文字列として自分の名字，名前，整数として自分の誕生日の日，月，年を別々に定義し，「名字 名前」，「yyyymmdd（年，月，日の順番で文字の足りないところにはゼロを入れる，例えば1999年1月1日→19990101）」としてそれぞれ文字列をターミナル出力せよ．以下要件：

    - 自分の名字，名前を格納する文字列長`last_name`，`first_name`は20とする
    - 例えば名字がAccounto，名前がRyotaの場合，「名字 名前」の出力結果は`Accounto Ryota`となるようにする（名字と名前の間には半角スペース一つのみ）
    - 例えば誕生日が1月の場合，整数`birth_m=1`→文字列`birth_mc=01`→yyyymmdd形式で出力，の手順を踏む

1. ParaViewで確認する
    壁の存在（`obs`），および`u`の分布をParaViewで確認せよ．以下要件：

    - `\\Mercury\Public\Share\Manual\ParaViewマニュアル\ParaViewマニュアル.html`を参考に出力する
    - 出力は`unformatted`+`stream`形式で
    - 障害物情報を格納している論理型`obs`のままでは可視化できないため，真→1，偽→0として整数型配列`Iobs(:,:)`に変換する
    - ...とはいってもマニュアルを見てなんだこれはとなるかもしれないので，解答例をすぐに見てもよい（ここの理解はFortranの本質ではないので）
    - 特に`obs`の場合と`u`の場合でどこが違うかを理解する

    （補足）「わざわざ真→1，偽→0の変換をせずとも，最初から01で障害物を表現しておけばいいのでは？」今回の問題に対してはまったくそれで構わない．プログラミング言語によっては論理型（ブーリアン：Booleanとも呼ばれる）を内部処理で01に直しているくらいである（なんならFortranでも`integer Iobs(:,:)=.true.`と書けばコンパイルで`Iobs(:,:)=1`に直すくらいである）．しかしどちらのほうがより明示的かを考えると，「obs（obstacle: 障害物）か？」と聞かれたら「.true. or .false.」で答えるのが自然である．そもそも01表現は2進数として障害物判定に限らずコンピュータの根幹表現なので，普遍的でない問題に対しては切り離して考えるほうが自然ではないだろうか...という長い言い訳．実情は`logical`の学習をさせるのに体が良かっただけである．

1. ParaView出力のサブルーチン化
    ParaView出力に関連する記述を外部サブルーチン（外部手続き）化せよ．以下要件：

    - 今は`end program main`のあとに`subroutine Output_for_ParaView`として記述する（外部サブルーチンなら別ファイルに記述することも可能だがその場合はコンパイル方法が異なる）
    - 似た記述が多いため`obs`と`u`の当該箇所をまとめて一つのサブルーチン`Output_for_ParaView`にしてもよいが，それぞれで別のサブルーチンにしてもよい（サブルーチンにするメリットが減るが）
    - 一つのサブルーチンにまとめる場合は，簡単のため`obs`の可視化も単精度実数で，つまり`u`と同じ型で行うようにすればよい（別の型でも実装は可能だが複雑になること請け合い）
    - 引数を用いる場合は`inout`属性をつける
    - 内部サブルーチン（内部手続き）化の場合も余力があれば行う

1. 二つの変数の中身を入れ替える方法を理解する
    新しいファイルで，`left=1d0`，`right=-1d0`で二つの変数を定義し，中身を入れ替えよ．以下要件：

    - 当然`left=-1d0`，`right=1d0`とはしない

1. 反復計算の実装と時系列データの作成

    時間方向の進行として反復計算用`do`ループを追加し，時系列データを作成してParaViewで経時変化を確認せよ．以下要件：

    - 時間進行は`do t=1,tmax`で記述する
    - タイムステップ数は`tmax=1000`としてパラメータ定義する
    - 時系列データの時間間隔として`period=10`をパラメータ定義する
    - `period`間隔ごとに，そのときのタイムステップ`t`をファイル名として連番ファイルとする（`t=10`のとき，`u00000010.vtk`，`t=100`のとき，`u00000100.vtk`）
    - `obs`のファイル名は`obs00000000.vtk`となってもよい（`u`の場合とサブルーチンの引数を共有できるため）

### 知っておくべき〇〇

工事中

1. gfortranの文字数制限解除オプションとして→があることをおまけ情報として　`-ffree-line-length-none`
1. doループのexitとcycle
1. doループのカウンタ変数の性質について
1. キャッシュについて=ijkで外側からする必要があること
1. csvファイルから読み込んでも元の数値と一致するわけではないという話
1. プリプロセッサ
1. システムコール
1. allocate (allocated, allocate, deallocate, メモリが確保できる (ヒープ領域))
1. より汎用性の高いコードを書く (例えば[[WIP]Fortranをコーディングする際に気をつけていること](https://qiita.com/implicit_none/items/9164c4d35d84e6e77f29))
1. よりreadable=可読性の高いコードを書く ([リーダブルコードまとめ](https://qiita.com/fkrw/items/7646563a2b238fbcff9a)：書籍自体は別にFortranユーザ向けのみに書いたわけではなくもっと一般的な話なのでFortranしか勉強していなければ取っつきにくい．リンク先のまとめは具体的なコードをあまり示していないので逆に分かりやすいかも．書籍自体は"\\Mercury\Public\Share\Books&Texts\リーダブルコード.pdf"として存在するので読みたければどうぞ)

### 一歩先へ

- AtCoderの問題をFortranで解く ([リンク](https://yukiutaai.wordpress.com/2018/03/21/atcoderに登録したら解くべき精選過去問10をfortranで解いて/))
- 熱伝導方程式を陰解法で解く

## 参考：これまでの養成講座（2020年度より前）

1. 名前を出力せよ．
1. 任意に入力した2つの数字同士の＋－×÷の計算結果を出力せよ．
1. 課題２の計算結果を任意のファイルに出力し，それを再び読み込んで端末に出力せよ．
1. a,b,cを実数で定義し，a =1.2,b=2.3とし，e,f,gを整数で定義しe=2,f=3,とし以下の計算を行い，c,gを出力し考察せよ．
   1. c=a+b
   1. g=a+b
   1. c=b/a
   1. g=b/a
   1. c=f/e
   1. g=f/e
   1. c=a/e
   1. g=a/e
1. 任意に数字を入力し，その数字が奇数ならその数字を二乗した数を，偶数ならその数字の平方根を出力せよ．
1. 1～100までで奇数だけの和と，偶数だけの和をそれぞれ求めよ．
1. 数列a(n)=3n^2+5n-2 (n=1,2,3,...) の総和が最初に1万を超える時のｎの値を求めよ．
1. ２×２行列同士の足し算を行い，できた行列の行列式を出力せよ．
1. ５×５行列同士の掛け算を行い，できた行列の各成分を任意のファイルに出力せよ．
1. 円周率πを倍精度で出力せよ．（ただしπは使用禁止！）
1. 任意に入力した2つの数字をサブルーチン内で＋－×÷の計算し，メインプログラムで結果を出力せよ．
1. (x-1)(x-2)(x-3)=0の近似解を求めよ．
1. 任意の３点の座標を入力し，その面積を出力せよ．三点が同一直線上に並ぶ場合は，エラーを出力せよ．
1. 任意に入力した９つの数字を昇順に並び替えて出力せよ．
1. 素数を４桁まで書き出せ。
1. f(x)=4x+1-exp(x)についてf(x)=0となるxを計算し，y=f(x)とx軸とで囲まれた図形の面積を区分求積法により求めよ．
1. 端末から2数a,bを読み込み，aCbを計算せよ．またこのとき1からaまでの数字を使って組み合わせをすべて書き出せ．ただしa<bではエラーを掃出し，再度2数を読み込め．
